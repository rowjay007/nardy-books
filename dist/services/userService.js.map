{"version":3,"file":"userService.js","sources":["services/userService.ts"],"sourceRoot":"/","sourcesContent":["import bcrypt from \"bcrypt\";\nimport crypto from \"crypto\";\nimport jwt from \"jsonwebtoken\";\nimport User, { IUser } from \"../models/userModel\";\nimport * as userRepository from \"../repositories/userRepository\";\nimport AppError from \"../utils/appError\";\nimport env from \"../config/env\";\nimport cache, { CACHE_TTL_SECONDS } from \"../utils/cache\";\nimport {\n  sendResetPasswordEmail,\n  sendVerificationEmail,\n  sendWelcomeEmail,\n} from \"../utils/emailUtils\";\n\nconst generateAccessToken = (userId: string) => {\n  return jwt.sign({ id: userId }, env.JWT_SECRET, {\n    expiresIn: \"1h\",\n  });\n};\n\nconst generateRefreshToken = (userId: string) => {\n  return jwt.sign({ id: userId }, env.REFRESH_TOKEN_SECRET, {\n    expiresIn: env.REFRESH_TOKEN_EXPIRATION,\n  });\n};\n\nexport const register = async (\n  username: string,\n  email: string,\n  password: string\n): Promise<IUser> => {\n  const verificationToken = crypto.randomBytes(32).toString(\"hex\");\n  const user = new User({\n    username,\n    email,\n    password, // Password will be hashed by the pre-save hook\n    verificationToken,\n  });\n  await user.save();\n\n  const verificationLink = `${env.EMAIL_VERIFICATION_URL}/${verificationToken}`;\n  await Promise.all([\n    sendWelcomeEmail(email, username, verificationLink),\n    sendVerificationEmail(email, verificationLink),\n  ]);\n\n  cache.flushAll();\n\n  return user;\n};\n\nexport const login = async (email: string, password: string) => {\n  if (!email.includes(\"@\") || !email.split(\"@\")[1].includes(\".\")) {\n    throw new AppError(\"Invalid email format\", 400);\n  }\n\n  const user = await userRepository.findUserByEmail(email);\n  if (!user) throw new AppError(\"Invalid email or password\", 401);\n\n  if (!user.isEmailVerified) {\n    throw new AppError(\"Email not verified\", 401);\n  }\n\n  const isPasswordCorrect = await bcrypt.compare(password, user.password);\n  if (!isPasswordCorrect) throw new AppError(\"Invalid email or password\", 401);\n\n  const accessToken = generateAccessToken(user._id as string);\n  const refreshToken = generateRefreshToken(user._id as string);\n\n  await userRepository.setRefreshToken(user._id as string, refreshToken);\n\n  return { user, accessToken, refreshToken };\n};\n\nexport const logout = async (userId: string) => {\n  await userRepository.removeRefreshToken(userId);\n  cache.flushAll();\n};\n\nexport const requestPasswordReset = async (email: string) => {\n  const user = await userRepository.findUserByEmail(email);\n  if (!user) throw new AppError(\"User not found\", 404);\n\n  const token = crypto.randomBytes(20).toString(\"hex\");\n  const expires = new Date(Date.now() + 3600000);\n\n  await userRepository.setResetPasswordToken(\n    user._id as string,\n    token,\n    expires\n  );\n\n  const resetLink = `${env.RESET_PASSWORD_URL}/reset-password/${token}`;\n  await sendResetPasswordEmail(email, resetLink);\n\n  return token;\n};\n\nexport const resetPassword = async (token: string, newPassword: string) => {\n  const user = await userRepository.findByResetPasswordToken(token);\n  if (!user) throw new AppError(\"Invalid or expired token\", 400);\n\n  user.password = newPassword;\n  user.resetPasswordToken = undefined;\n  user.resetPasswordExpires = undefined;\n  await user.save();\n\n  cache.flushAll();\n\n  return user;\n};\n\nexport const changePassword = async (\n  userId: string,\n  currentPassword: string,\n  newPassword: string\n) => {\n  const user = await userRepository.findUserById(userId);\n  if (!user) throw new AppError(\"User not found\", 404);\n\n  const isPasswordCorrect = await bcrypt.compare(\n    currentPassword,\n    user.password\n  );\n  if (!isPasswordCorrect)\n    throw new AppError(\"Current password is incorrect\", 401);\n\n  user.password = newPassword; \n  await user.save();\n\n  cache.flushAll();\n\n  return user;\n};\n\nexport const verifyEmail = async (\n  verificationToken: string\n): Promise<IUser> => {\n  const user = await User.findOneAndUpdate(\n    { verificationToken },\n    { $set: { isEmailVerified: true, verificationToken: undefined } },\n    { new: true }\n  );\n\n  if (!user) {\n    throw new AppError(\"Invalid verification token.\", 400);\n  }\n\n  cache.flushAll();\n\n  return user;\n};\n\nexport const resendVerificationEmail = async (userId: string) => {\n  const user = await userRepository.findUserById(userId);\n  if (!user) throw new AppError(\"User not found\", 404);\n\n  const verificationToken = crypto.randomBytes(32).toString(\"hex\");\n  user.verificationToken = verificationToken;\n  await user.save();\n\n  const verificationLink = `${env.EMAIL_VERIFICATION_URL}/verify-email/${verificationToken}`;\n  await sendVerificationEmail(user.email, verificationLink);\n\n  cache.flushAll();\n};\n\nexport const getUserById = async (userId: string): Promise<IUser | null> => {\n  const cacheKey = `user_${userId}`;\n  let user = cache.get<IUser | null>(cacheKey);\n\n  if (user === undefined) {\n    user = await userRepository.findUserById(userId);\n    if (user) {\n      cache.set(cacheKey, user, CACHE_TTL_SECONDS);\n    }\n  }\n\n  return user;\n};\n\nexport const getAllUsers = async (\n  filter: any,\n  sort: any,\n  limit: number,\n  skip: number\n) => {\n  const cacheKey = `allUsers_${JSON.stringify({ filter, sort, limit, skip })}`;\n  let users = cache.get<IUser[]>(cacheKey);\n\n  if (!users) {\n    users = await userRepository.findUsers(filter, sort, limit, skip);\n    cache.set(cacheKey, users, CACHE_TTL_SECONDS);\n  }\n\n  return users;\n};\n\nexport const updateUser = async (userId: string, updateData: any) => {\n  const user = await userRepository.updateUser(userId, updateData);\n  if (user) {\n    cache.flushAll();\n  }\n  return user;\n};\n\nexport const deleteUser = async (userId: string): Promise<boolean> => {\n  const result = await userRepository.deleteUser(userId);\n  cache.flushAll();\n  return result !== null;\n};\n\n"],"names":[],"mappings":"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","debug_id":"6c83f979-10c3-5e37-b8ca-e395a70aef59"}