{"version":3,"file":"authController.js","sources":["controllers/authController.ts"],"sourceRoot":"/","sourcesContent":["import { Request, Response, NextFunction } from \"express\";\nimport jwt from \"jsonwebtoken\";\nimport env from \"../config/env\";\nimport userService from \"../services/userService\";\nimport AppError from \"../utils/appError\";\nimport httpStatus from \"http-status\";\n\ninterface AuthenticatedRequest extends Request {\n  user?: string | jwt.JwtPayload;\n}\n\n/**\n * Generates an access token for the given user ID\n * @param {string} userId - User ID\n * @returns {string} Generated access token\n */\nconst generateAccessToken = (userId: string): string => {\n  return jwt.sign({ id: userId }, env.JWT_SECRET, {\n    expiresIn: \"1h\",\n  });\n};\n\n/**\n * Generates a refresh token for the given user ID\n * @param {string} userId - User ID\n * @returns {string} Generated refresh token\n */\nconst generateRefreshToken = (userId: string): string => {\n  return jwt.sign({ id: userId }, env.REFRESH_TOKEN_SECRET, {\n    expiresIn: env.REFRESH_TOKEN_EXPIRATION,\n  });\n};\n\n/**\n * Controller function to register a new user\n * @param {Request} req - Express request object with body containing username, email, and password\n * @param {Response} res - Express response object\n * @param {NextFunction} next - Express next function\n * @returns {Promise<void>} - Returns a JSON object with the created user data\n */\nexport const register = async (\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> => {\n  const { username, email, password } = req.body;\n\n  try {\n    const user = await userService.register(username, email, password);\n\n    res.status(httpStatus.CREATED).json({\n      status: \"success\",\n      data: { user },\n    });\n  } catch (error) {\n    next(error);\n  }\n};\n\n/**\n * Controller function to authenticate a user and generate access token\n * @param {Request} req - Express request object with body containing email and password\n * @param {Response} res - Express response object\n * @param {NextFunction} next - Express next function\n * @returns {Promise<void>} - Returns a JSON object with the authenticated user data and access token\n */\nexport const login = async (\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> => {\n  const { email, password } = req.body;\n\n  try {\n    const { user, accessToken } = await userService.login(email, password);\n\n    res.status(httpStatus.OK).json({\n      status: \"success\",\n      data: { user, accessToken },\n    });\n  } catch (error) {\n    next(error);\n  }\n};\n\n/**\n * Controller function to logout a user\n * @param {AuthenticatedRequest} req - Express request object extended with user information\n * @param {Response} res - Express response object\n * @param {NextFunction} next - Express next function\n * @returns {Promise<void>} - Returns a JSON object indicating successful logout\n */\nexport const logout = async (\n  req: AuthenticatedRequest,\n  res: Response,\n  next: NextFunction\n): Promise<void> => {\n  const userId = getUserIdFromRequest(req);\n\n  try {\n    if (!userId) {\n      throw new AppError(\"User not authenticated\", httpStatus.UNAUTHORIZED);\n    }\n\n    await userService.logout(userId);\n\n    res.status(httpStatus.NO_CONTENT).json({\n      status: \"success\",\n      data: null,\n    });\n  } catch (error) {\n    next(error);\n  }\n};\n\n/**\n * Controller function to refresh access and refresh tokens\n * @param {Request} req - Express request object with body containing refreshToken\n * @param {Response} res - Express response object\n * @param {NextFunction} next - Express next function\n * @returns {Promise<void>} - Returns a JSON object with new access and refresh tokens\n */\nexport const refreshTokens = async (\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> => {\n  const refreshToken = req.body.refreshToken;\n\n  if (!refreshToken) {\n    return next(\n      new AppError(\"Refresh token is required\", httpStatus.BAD_REQUEST)\n    );\n  }\n\n  try {\n    const decoded = jwt.verify(refreshToken, env.REFRESH_TOKEN_SECRET) as {\n      id: string;\n    };\n\n    const accessToken = generateAccessToken(decoded.id);\n    const newRefreshToken = generateRefreshToken(decoded.id);\n\n    res.status(httpStatus.OK).json({\n      status: \"success\",\n      data: { accessToken, refreshToken: newRefreshToken },\n    });\n  } catch (error) {\n    next(\n      new AppError(\"Invalid or expired refresh token\", httpStatus.UNAUTHORIZED)\n    );\n  }\n};\n\n/**\n * Controller function to request a password reset for a user\n * @param {Request} req - Express request object with body containing email\n * @param {Response} res - Express response object\n * @param {NextFunction} next - Express next function\n * @returns {Promise<void>} - Returns a JSON object with a password reset token\n */\nexport const requestPasswordReset = async (\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> => {\n  const { email } = req.body;\n\n  try {\n    const token = await userService.requestPasswordReset(email);\n\n    res.status(httpStatus.OK).json({\n      status: \"success\",\n      data: { token },\n    });\n  } catch (error) {\n    next(error);\n  }\n};\n\n/**\n * Controller function to reset a user's password using a reset token\n * @param {Request} req - Express request object with params containing token and body containing newPassword\n * @param {Response} res - Express response object\n * @param {NextFunction} next - Express next function\n * @returns {Promise<void>} - Returns a JSON object with the updated user data\n */\nexport const resetPassword = async (\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> => {\n  const { token } = req.params;\n  const { newPassword } = req.body;\n\n  try {\n    const user = await userService.resetPassword(token, newPassword);\n\n    res.status(httpStatus.OK).json({\n      status: \"success\",\n      data: { user },\n    });\n  } catch (error) {\n    next(error);\n  }\n};\n\n/**\n * Controller function to change a user's password\n * @param {AuthenticatedRequest} req - Express request object extended with user information\n * @param {Response} res - Express response object\n * @param {NextFunction} next - Express next function\n * @returns {Promise<void>} - Returns a JSON object with the updated user data\n */\nexport const changePassword = async (\n  req: AuthenticatedRequest,\n  res: Response,\n  next: NextFunction\n): Promise<void> => {\n  const { currentPassword, newPassword } = req.body;\n  const userId = getUserIdFromRequest(req);\n\n  try {\n    if (!userId) {\n      throw new AppError(\"User not authenticated\", httpStatus.UNAUTHORIZED);\n    }\n\n    const user = await userService.changePassword(\n      userId,\n      currentPassword,\n      newPassword\n    );\n\n    res.status(httpStatus.OK).json({\n      status: \"success\",\n      data: { user },\n    });\n  } catch (error) {\n    next(error);\n  }\n};\n\n/**\n * Controller function to verify a user's email using a verification token\n * @param {Request} req - Express request object with params containing token\n * @param {Response} res - Express response object\n * @param {NextFunction} next - Express next function\n * @returns {Promise<void>} - Returns a JSON object with the updated user data\n */\nexport const verifyEmail = async (\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> => {\n  const { token } = req.params;\n\n  try {\n    const user = await userService.verifyEmail(token);\n\n    res.status(httpStatus.OK).json({\n      status: \"success\",\n      message: \"Email verified successfully.\",\n      data: { user },\n    });\n  } catch (error) {\n    next(error);\n  }\n};\n\n/**\n * Controller function to resend a verification email to the authenticated user\n * @param {AuthenticatedRequest} req - Express request object extended with user information\n * @param {Response} res - Express response object\n * @param {NextFunction} next - Express next function\n * @returns {Promise<void>} - Returns a JSON object indicating success message\n */\nexport const resendVerificationEmail = async (\n  req: AuthenticatedRequest,\n  res: Response,\n  next: NextFunction\n): Promise<void> => {\n  const userId = getUserIdFromRequest(req);\n\n  try {\n    if (!userId) {\n      throw new AppError(\"User not authenticated\", httpStatus.UNAUTHORIZED);\n    }\n\n    await userService.resendVerificationEmail(userId);\n\n    res.status(httpStatus.OK).json({\n      status: \"success\",\n      message: \"Verification email resent successfully\",\n    });\n  } catch (error) {\n    next(error);\n  }\n};\n\n/**\n * Helper function to extract user ID from the request\n * @param {AuthenticatedRequest} req - Express request object extended with user information\n * @returns {string | undefined} - User ID if found, otherwise undefined\n */\nconst getUserIdFromRequest = (\n  req: AuthenticatedRequest\n): string | undefined => {\n  const user = req.user as jwt.JwtPayload | undefined;\n  return user?.id as string | undefined;\n};\n\nexport { generateAccessToken, generateRefreshToken };\n"],"names":[],"mappings":"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","debug_id":"d607db3c-933a-57cb-b4be-9db211a022b5"}